<!DOCTYPE html>
<html>
<title>Flask image2text</title>
<body>
<style>
  @import url('https://fonts.googleapis.com/css?family=Assistant&display=swap');
  html, body {
  width:  100%;
  height: 100%;
  margin: 1%;
  }
  body {
    background: rgb(37, 26, 48);
    font-family:'Assistant', sans-serif;
    color: white;
    font-size: 16px;
  }
  input[type=submit] {
    background-color: #755fd4;
    border-radius: 16px;
    border: none;
    color: white;
    padding: 8px 16px;
    cursor: pointer;
    height: 37px;
  }
  input[type=file] {
    background-color: #755fd4;
    border-radius: 14px;
    border: none;
    color: white;
    padding: 8px 16px;
    cursor: pointer;
  }
  .column {
    float: left;
  }
  .left {
    width: 60%;
  }
  .row:after {
    content: "";
    display: table;
    clear: both;
  }
  #show_config {
    background-color: #755fd4;
    border-radius: 16px;
    padding: 11px 16px;
    border: none;
    color: white;
    cursor: pointer;
    margin-top: 17px;
  }
  #canvas{
    background-image: url("{{filename}}");
    background-size:     cover;
  }
  a {
    font-family:'Assistant';
    color: white;
    font-size: 16px;
  }
  .btn_custom {
    background-color: #755fd4;
    border-radius: 16px;
    /* padding: 50px 50px; */
    width: 120px;
    height: 37px;
    border: none;
    color: white;
    cursor: pointer;
    /* margin: 20px; */
  }
  img {
  border: 0px solid #ddd;
  border-radius: 10px;
  padding: 2px;
  /* width: 150px; */
  /* box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19); */
  }

  img:hover {
    border: 1px solid #ddd;
    /* border: 0 0 2px 1px #e4bd3e; */
    /* padding: 5px; */
  }
</style>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script>
  var img_path = "{{filename}}"
  var canvas = null;
  var ctx = null;
  var imageObj = null;
  var rectangles = [];
  var rectnames = []
  
  var isDrawing = false;
  var mouseStartX = 0.0;
  var mouseStartY = 0.0;
  var mouseEndX = 0.0;
  var mouseEndY = 0.0;
  var scale_img = 1.0
  //var len_rectangles = 0
  var list_config_files = []

  {% if config_filename != '' %}
    rectnames = {{ rectnames | tojson | safe }}
    rectangles = {{ rectangles | tojson | safe }}
    scale_img = {{ scale_img | tojson | safe}}
  {% endif %}

  {% if list_config_files != '' %}
    list_config_files = {{ list_config_files | tojson | safe }}
  {% endif %}

  var cur_rectangle = rectangles[rectangles.length - 1]

  function Rectangle(x,y,width,height) {
    this.x = x;
    this.y = y;
    this.width = width;
    this.height = height;
  }
  function initCanvas(){
    canvas = document.getElementById("canvas");
    ctx = canvas.getContext("2d");
    imageObj = new Image();
    imageObj.onload = function () { 
        canvas.width = window.innerWidth*0.6;
        scale_img = window.innerWidth/this.width
        canvas.height = this.height*scale_img*0.6;
        console.log(canvas.width, canvas.height)
        console.log(this.width, this.height)   
    };
     imageObj.src = img_path;
  }

  function showConfig(){
    addManyRectname()
    draw()
    //console.log('sau draw')
  }

  function addRectname(index){
    var num_cur_rect = index

    var rect_a = document.createElement("a")
    rect_a.setAttribute("id","rect_a"+num_cur_rect)
    rect_a.innerHTML = '#'+ num_cur_rect + ' ['

    var rectname = document.createElement("a")
    rectname.setAttribute("id","rectname_input"+num_cur_rect)
    rectname.innerHTML = rectnames[index-1] + "]:"
    
    var rect_text = document.createElement("a")
    rect_text.setAttribute("id","rect_text"+num_cur_rect)
    
    var p = document.createElement("p")
    p.setAttribute("id","rect_p"+num_cur_rect)
    
    document.getElementById("list_rect").appendChild(rect_a)
    document.getElementById("list_rect").appendChild(rectname)
    document.getElementById("list_rect").appendChild(rect_text)
    document.getElementById("list_rect").appendChild(p)
  }
  function addManyRectname(){
    for (var i = 0; i < rectangles.length; ++i){
      addRectname(i+1)
    }
  }

  function clearAllRectname(flag = false){
      var len_tmp = rectangles.length
      if (flag==true){
        len_tmp = len_tmp + 1;
      }
      for (var n=0; n < len_tmp; ++n){
      var rect = document.getElementById("rect_a"+parseInt(n+1))
      var rectname = document.getElementById("rectname_input"+parseInt(n+1))
      var rect_text = document.getElementById("rect_text"+parseInt(n+1))
      var p = document.getElementById("rect_p"+parseInt(n+1))

      document.getElementById("list_rect").removeChild(rect)
      document.getElementById("list_rect").removeChild(rectname)
      document.getElementById("list_rect").removeChild(rect_text)
      document.getElementById("list_rect").removeChild(p)
      }
    }
  
  function clearAll(){
    clearAllRectname();
    rectangles = []
    rectnames = []
    cur_rectangle = null
    draw()
  }
  function draw() {
    ctx.clearRect( 0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.strokeStyle = "green";
    ctx.fillStyle = "red";
    ctx.lineWidth = 2;
    ctx.font = "bold 14pt Courier";
    ctx.beginPath();
    for (var i = 0; i < rectangles.length; ++i) {
      var rectangle = rectangles[i];
      ctx.rect( rectangle.x, rectangle.y, rectangle.width, rectangle.height);
      ctx.fillText("#" + (i+1) + "[" + rectnames[i] + "]", rectangle.x , rectangle.y - 3);
    }
    ctx.closePath()
    ctx.stroke();
  }

  window.onload = function() {
    initCanvas()
    showListConfigFiles()
    if (rectangles.length > 0){
      console.log(rectangles.length)
      showConfig()
      draw()
    }
  }

function combineRectName(){
  rectangles_with_name = []
  for (var j=0; j<rectangles.length; ++j){
    rectname_tmp = document.getElementById('rectname_input'+(j+1)).value
    rectangle_tmp = rectangles[j]
    rectangles_with_name.push({rectname:rectname_tmp, rectangle:rectangle_tmp})
  }
  return rectangles_with_name
}

function showRectnamed(){
  for (var l=0; l<rectangles.length; ++l){
    document.getElementById('rectname'+(l+1)).placeholder = rectnames[l]
  }
}

function postRecognizeAllRectangles(){
  if (rectangles.length == 0){
      alert('Select config file!')
  }
  else{
      document.getElementById("btn_recognition_all_rect").value = "Đang xử lý"
      $.ajax({
      type: "POST",
      url: '/recognize_all_rectangles2',
      data: JSON.stringify({rectangles:rectangles, scale_img:scale_img}),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success:function (response) {
          console.log('postOneRectangles() successed!:',response)
          if (response.success == true){
            console.log("server ocr successed!")
            console.log(response.data)
            document.getElementById("btn_recognition_all_rect").value = "Nhận dạng tất cả trường"
            for (var n=0; n< rectangles.length; ++n){
              document.getElementById("rect_text"+parseInt(n+1)).innerHTML = "<span style='color:gold;'> "+response.data[n] + " </span>"
              }
            }
          else {console.log("server ocr error!")}
          }});
  }
}
function checkSelectImageFile(){
  img = document.getElementById("select_config_file")
  var file = document.forms['form_upload2']['file2'].files[0];
  if (typeof(file) == 'undefinedd'){
    alert('Chọn mẫu trước!')
  }
  else{
    window.location.href = '/preprocess_image';
  }
}

function showListConfigFiles(){
  for (var i =0; i< list_config_files.length; ++i){
    var cf_name = document.createElement('a')
    cf_name.setAttribute('id','cf_name'+i)
    cf_name.innerHTML = "<img src='static/mau/"+list_config_files[i]+".png' width='200'; title='Xem mẫu'> <p style='margin-top:0px; margin-bottom: 25px;'> Mẫu "+ parseInt(i+1) + ":" + "<span style='color:gold;'> " + list_config_files[i] + " </span></p>"
    cf_name.setAttribute('href',list_config_files[i])
    cf_name.setAttribute('style','margin-bottom:17px;')

    var cf_p = document.createElement('p')

    document.getElementById('list_config').appendChild(cf_name)
    document.getElementById('list_config').appendChild(cf_p)
  }
}
$("#btn_upload_img").on("click", function(){

});
</script>

<div class="row">
  <div class="column">
    {% if filename == '' %}
      <h5></h5>
    {% else %}
      <canvas id="canvas" style="text-align:left;"></canvas>
    {% endif %}
  </div>
  <div class="column" style="text-align: right;">
    <div class="xuli" style="text-align: center; padding-left: 50px; padding-top: 10px;">
      <button class="btn_custom" onclick="window.location.href = '/';">Trang chủ</button>
      <!--form upload image-->
      {% if filename == '' %}
      <h5 id='filename'>Chọn ảnh</h5>
      {% else %}
      <h5 id='filename'>Ảnh đã chọn: <span style="color: gold;">{{filename}}</span></h5>
      {% endif %}

      <form name ='form_upload' method="post" action="/uploadImage2" enctype="multipart/form-data">
        <input name="file" type="file" id="select_file"/>
        <input id="btn_upload_img" type="submit" value="Tải ảnh lên">
      </form>
      <div class="h5" style=" margin-top:10px">Chọn ảnh demo:</div>
      <div id="demo_img" style="padding-top: 10px;">
        <a href="/demo_static_demo_hoadontiendien-3.png"><img src="static/demo/hoadontiendien-3.png" alt="" width="50" style="border-radius: 5px;"></a>
        <a href="/demo_static_demo_hoadontiendien-2.png"><img src="static/demo/hoadontiendien-2.png" alt=""  width="50" style="border-radius: 5px;"></a>
        <a href="/demo_static_demo_cccd-1.png"><img src="static/demo/cccd-1.png" alt=""  width="50" style="border-radius: 5px;"></a>
        <a href="/demo_static_demo_cccd-2.png"><img src="static/demo/cccd-2.png" alt=""  width="50" style="border-radius: 5px;"></a>
        <a href="/demo_static_demo_cccd-3.png"><img src="static/demo/cccd-3.png" alt=""  width="50" style="border-radius: 5px;"></a>
      </div>
      <!-- <input id="btn_autodetect" type="submit" value="Auto Detect" onclick="javascript:postAutoDetect()" style="margin-top: 17px;"></input> -->
      <!--form upload config-->
      <!-- <button class="btn_custom" onclick="showListConfigFiles()" style="margin-top: 17px;">Xem mẫu có sẵn</button> -->
      <!-- {% if config_filename == '' %}
      <h5 id='config_filename'>Chọn mẫu</h5>
      {% else %}
      <h5 id='config_filename'>Mẫu đã chọn: <span style="color:gold;">{{config_filename}}</span></h5>
      {% endif %} 
      <form name ='form_upload2' method="post" action="/uploadConfig2" enctype="multipart/form-data">
        <input name="file2" type="file" id="select_config_file"/>
        <input id="btn_upload_config" type="submit" value="Tải mẫu lên">
      </form> -->
      <!-- <button id="show_config" onclick="javascript:showConfig()">Hiện mẫu đã chọn</button> -->
      <!-- <h5 id="num_box">Num rects</h5> -->
      <p>
        <!-- <input id="btn_recognition_cur_rect" type="submit" value="Recognize current rect" onclick="javascript:postRecognizeOneRectangle()"></input> -->
        
        <!-- <button class="btn_custom" onclick="window.location.reload(true);">OK</button> -->
        
        <button class="btn_custom" onclick="window.location.href = '/preprocess_image';">Tiền xử lý ảnh</button>
        <input id="btn_recognition_all_rect" type="submit" value="Nhận dạng tất cả trường" onclick="javascript:postRecognizeAllRectangles()"></input>
        <div class="h5" style="margin-bottom: 10px;">Chọn mẫu:</div>
        <div id="list_config" ></div>
      </p>
      <!-- <input id="btn_clear_all" type="submit" value="Clear" onclick="javascript:clearAll()"></input> -->
      <div id="list_rect" style="text-align: initial; margin-left: 20px;"></div>
      <!-- <h5>Save filename</h5>
      <p><input id ="config_filename_pl" placeholder=""></input></p>
      <p><input type="submit" value="Save rects" onclick="javascript:postRectangles()"></input></p> -->
      <!-- <div id="preview">
        <img src="static/upload/align-tranf2.png">
      </div> -->
    </div>
  </div>
</div>
</body>
</html>